<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ÄÄƒng kÃ½ nhÃ¢n viÃªn</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    body {
      background: #f4f6f9;
    }

    .card {
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
    }

    .camera-box {
      background: #000;
      border-radius: 14px;
      overflow: hidden;
      aspect-ratio: 4 / 3;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .camera-box img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .status-badge {
      font-size: 0.95rem;
    }

    .hint {
      font-size: 0.9rem;
      color: #6c757d;
    }
  </style>
</head>

<body class="p-4">

<div class="container" style="max-width: 1100px;">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">
      <i class="bi bi-person-plus-fill"></i>
      ÄÄƒng kÃ½ nhÃ¢n viÃªn má»›i
    </h3>
    <a href="/" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left"></i> Trang chá»§
    </a>
  </div>

  <div class="card p-4">
    <div id="alert-area"></div>

    <div class="row g-4">

      <!-- CAMERA -->
      <div class="col-md-7">
        <div class="camera-box mb-3">
          <img id="video" src="/video_feed" alt="Camera preview">
        </div>

        <div>
          <strong>Tráº¡ng thÃ¡i:</strong>
          <span id="status" class="badge bg-secondary status-badge">idle</span>
        </div>
        <div id="counts" class="hint mt-1"></div>
      </div>

      <!-- FORM -->
      <div class="col-md-5">
        <div class="mb-3">
          <label class="form-label fw-semibold">
            <i class="bi bi-person"></i> TÃªn nhÃ¢n viÃªn
          </label>
          <input id="nameInput" class="form-control form-control-lg"
                 placeholder="Nháº­p tÃªn Ä‘áº§y Ä‘á»§">
        </div>

        <div class="d-grid gap-2">
          <button id="startSessionBtn" class="btn btn-primary btn-lg">
            <i class="bi bi-camera-video"></i> Hiá»ƒn thá»‹ camera
          </button>

          <button id="startCaptureBtn" class="btn btn-success btn-lg" disabled>
            <i class="bi bi-record-circle"></i> Báº¯t Ä‘áº§u thu áº£nh
          </button>
        </div>

        <div class="mt-3 hint">
          ğŸ“Œ Äáº£m báº£o:
          <ul class="mb-0">
            <li>GÆ°Æ¡ng máº·t rÃµ, Ä‘á»§ sÃ¡ng</li>
            <li>NhÃ¬n tháº³ng vÃ o camera</li>
            <li>KhÃ´ng Ä‘á»™i mÅ© / Ä‘eo kháº©u trang</li>
          </ul>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
async function post(url, data){
  const fd = new FormData();
  for(const k in data) fd.append(k, data[k]);
  const res = await fetch(url, {method:'POST', body: fd});
  return res.json();
}

const startBtn = document.getElementById('startSessionBtn');
const captureBtn = document.getElementById('startCaptureBtn');
const nameInput = document.getElementById('nameInput');
const statusEl = document.getElementById('status');
const countsEl = document.getElementById('counts');
const alertArea = document.getElementById('alert-area');

startBtn.addEventListener('click', async ()=>{
  const name = nameInput.value.trim();
  if(!name){
    alertArea.innerHTML =
      '<div class="alert alert-warning">Vui lÃ²ng nháº­p tÃªn nhÃ¢n viÃªn</div>';
    return;
  }

  startBtn.disabled = true;
  const r = await post('/start_session', {name});
  startBtn.disabled = false;

  if(r.ok){
    alertArea.innerHTML =
      '<div class="alert alert-success">ÄÃ£ táº¡o session. Äiá»u chá»‰nh khuÃ´n máº·t vÃ  nháº¥n "Báº¯t Ä‘áº§u thu áº£nh"</div>';
    captureBtn.disabled = false;
  } else {
    alertArea.innerHTML =
      '<div class="alert alert-danger">'+(r.error||'Lá»—i')+'</div>';
  }
});

captureBtn.addEventListener('click', async ()=>{
  captureBtn.disabled = true;
  const r = await post('/start_capture', {});
  if(!r.ok){
    alert('Lá»—i: '+(r.error||''));
    captureBtn.disabled = false;
  }
});

// Poll status
setInterval(async ()=>{
  try{
    const r = await fetch('/capture_status');
    const j = await r.json();

    statusEl.textContent = j.status;
    statusEl.className = 'badge status-badge ' +
      (j.status === 'completed' ? 'bg-success' :
       j.status === 'capturing' ? 'bg-warning text-dark' :
       'bg-secondary');

    countsEl.textContent = j.counts ? JSON.stringify(j.counts) : '';

  }catch(e){}
}, 800);
</script>

</body>
</html>
